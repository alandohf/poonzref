<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<!--Converted with LaTeX2HTML 2002-2-1 (1.71)
original version by:  Nikos Drakos, CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippmann, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>13.19 我怎样才知道对于任意的&nbsp;sprintf&nbsp;调用需要多大的目标缓冲区？
怎样才能避免&nbsp;sprintf()&nbsp;目标缓冲区溢出？</TITLE>
<META NAME="description" CONTENT="13.19 我怎样才知道对于任意的&nbsp;sprintf&nbsp;调用需要多大的目标缓冲区？
怎样才能避免&nbsp;sprintf()&nbsp;目标缓冲区溢出？">
<META NAME="keywords" CONTENT="ccfaq">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=GBK">
<META NAME="Generator" CONTENT="LaTeX2HTML v2002-2-1">
<META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css">

<LINK REL="STYLESHEET" HREF="ccfaq.css">

<LINK REL="next" HREF="node211.html">
<LINK REL="previous" HREF="node209.html">
<LINK REL="up" HREF="node191.html">
<LINK REL="next" HREF="node211.html">
</HEAD>

<BODY >

<DIV CLASS="navigation"><table width=100%> <COLGROUP><COL width="25%"><COL width="25%"><col width="25%"><col width="25%"></colgroup><tr><td align=left>
<A NAME="tex2html3216"
  HREF="node209.html">
<IMG WIDTH="62" HEIGHT="25" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A></td><td align=center>
<A NAME="tex2html3222"
  HREF="node191.html">
<IMG WIDTH="61" HEIGHT="25" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A></td><td align=center>&nbsp;
<A NAME="tex2html3224"
  HREF="node1.html">
<IMG WIDTH="63" HEIGHT="25" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A>&nbsp;</td><td align=right>
<A NAME="tex2html3226"
  HREF="node211.html">
<IMG WIDTH="62" HEIGHT="25" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A></td></tr></table>
</DIV>
<!--End of Navigation Panel-->

<H1><A NAME="SECTION0014190000000000000000"></A>
<A NAME="q:12.21"></A>
<BR>
<SPAN CLASS="arabic">13</SPAN>.<SPAN CLASS="arabic">19</SPAN> 我怎样才知道对于任意的&nbsp;sprintf&nbsp;调用需要多大的目标缓冲区？
怎样才能避免&nbsp;sprintf()&nbsp;目标缓冲区溢出？
</H1>
当用于&nbsp;sprintf()&nbsp;的格式串已知且相对简单时, 你有时可以预测出缓冲区的大小。
如果格式串中包含一个或两个&nbsp;%s, 你可以数出固定字符的个数再加上对插入的
字符串的&nbsp;strlen()&nbsp;调用的返回值。对于整形, %d&nbsp;输出的字符数不会超过
<PRE>
	((sizeof(int) * CHAR_BIT + 2) / 3 + 1)  /* +1 for '-' */
</PRE>
CHAR_BIT&nbsp;在&nbsp;&lt;limits.h&gt;&nbsp;中定义, 但是这个计算可能
有些过于保守了。它计算的是数字以八进制存储需要的字节数; 十进制的存储可
以保证使用同样或更少的字节数。

<P>
当格式串更复杂或者在运行前未知的时候, 预测缓冲区大小会变得跟重新实现&nbsp;
sprintf&nbsp;一样困难, 而且会很容易出错。有一种最后防线的技术, 就是&nbsp;fprintf()&nbsp;
向一块内存区或临时文件输出同样的内容, 然后检查&nbsp;fprintf&nbsp;的返回值或临时文件
的大小, 但请参见问题&nbsp;<A HREF="node320.html#q:19.12">19.14</A>, 并提防写文件错误。

<P>
如果不能确保缓冲区足够大, 你就不能调用&nbsp;sprintf(), 以防缓冲区溢出后改写
其它的内存区。如果格式串已知, 你可以用&nbsp;%.Ns&nbsp;控制&nbsp;%s&nbsp;扩展的长度,
或者使用&nbsp;%.*s, 参见问题&nbsp;<A HREF="node200.html#q:12.10">12.9</A>。

<P>
要避免溢出问题, 你可以使用限制长度的&nbsp;sprintf()&nbsp;版本, 即&nbsp;snprintf()。
这样使用：
<PRE>
    snprintf(buf, bufsize, "You typed \"%s\"", answer);
</PRE>
snprintf()&nbsp;在几个&nbsp;stdio&nbsp;库中已经提供好几年了, 包括&nbsp;GNU&nbsp;和&nbsp;4.4bsd。
在&nbsp;C99&nbsp;中已经被标准化了。

<P>
作为一个额外的好处, C99&nbsp;的&nbsp;snprintf()&nbsp;提供了预测任意&nbsp;sprintf()&nbsp;调用所需的
缓冲区大小的方法。C99&nbsp;的&nbsp;snprintf()&nbsp;返回它可能放到缓冲区的字符数, 而它又
可以用&nbsp;0&nbsp;作为缓冲区大小进行调用。因此
<PRE>
	nch = snprintf(NULL, 0, fmtstring, /* 其它参数 */ );
</PRE>
这样的调用就可以预测出格式串扩展后所需要的字符数。

<P>
另一个&nbsp;(非标准的)&nbsp;选择是&nbsp;asprintf()&nbsp;函数, 在&nbsp;bsd&nbsp;和&nbsp;GNU&nbsp;的&nbsp;C&nbsp;库中都有提供,
它调用&nbsp;malloc&nbsp;为格式串分配空间, 并返回分配内存区的指针。这样使用:
<PRE>
	char *buf;
	asprintf(&amp;buf, "%d = %s", 42, "forty-two");
	/* 现在, buf 指向含有格式串的 malloc 的内存 */
</PRE>

<P>
参考资料: [<A
 HREF="node388.html#c9x">C9X</A>, Sec. 7.13.6.6]。

<P>

<DIV CLASS="navigation"><HR> <table width=100%> <COLGROUP><COL width="25%"><COL width="25%"><col width="25%"><col width="25%"></colgroup><tr><td align=left>
<A NAME="tex2html3216"
  HREF="node209.html">
<IMG WIDTH="62" HEIGHT="25" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A></td><td align=center>
<A NAME="tex2html3222"
  HREF="node191.html">
<IMG WIDTH="61" HEIGHT="25" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A></td><td align=center>&nbsp;
<A NAME="tex2html3224"
  HREF="node1.html">
<IMG WIDTH="63" HEIGHT="25" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A>&nbsp;</td><td align=right>
<A NAME="tex2html3226"
  HREF="node211.html">
<IMG WIDTH="62" HEIGHT="25" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A></td></tr></table>
</DIV>
<!--End of Navigation Panel-->
<ADDRESS>
<small>翻译朱群英、孙云, LaTeX2HTML 编译 朱群英 (2005-06-23)</small>
</ADDRESS>
</BODY>
</HTML>
